name: API Automation
trigger:
  branches:
    include:
    - main
  paths:
    include:
    - API_Automation_Cypress
    exclude:
    - .pipelines
    - 510
    - Hotfixtest
    - URS_TST

resources:
- repo: self

pool:
  # vmImage: 'windows-latest'
  name: Automation
  demands:
    - agent.name -equals DGA1APP03RNSQA

jobs:
- job: cypress
  steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'specific'
        project: '1692ec27-30a7-44ac-bb45-41f0b3ec9f01'
        pipeline: '99'
        buildVersionToDownload: 'specific'
        buildId: '$(buildId)'
        downloadType: 'single'
        artifactName: 'RS2Build'
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: PowerShell@2
      displayName: 'Run Service Host'
      inputs:
        targetType: 'inline'
        script: |
          Start-Process -FilePath "$(System.DefaultWorkingDirectory)\API_Automation_Cypress\BatchFile\ServiceHost.bat" 

    - task: CmdLine@2
      displayName: 'NPM initialization'
      inputs:
        script: |
          npm install
          npm i   
        workingDirectory: '$(System.DefaultWorkingDirectory)/API_Automation_Cypress/Modulewise_TestCases'

    - task: BatchScript@1
      displayName: 'Run Cypress Scripts'
      inputs:
        filename: '$(System.DefaultWorkingDirectory)/API_Automation_Cypress/BatchFile/RunScripts.bat'

    - task: ArchiveFiles@2
      condition: AND(succeededOrFailed(),ne(canceled(), 'true'))
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)\API_Automation_Cypress\Modulewise_TestCases\cypress\reports'
        includeRootFolder: true
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)\reports.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      condition: AND(succeededOrFailed(),ne(canceled(), 'true'))
      inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)\reports.zip'
          ArtifactName: 'drop'
          publishLocation: 'Container'
        
  
  # - task: SendEmail@1
  #   condition: AND(succeededOrFailed(),ne(canceled(), 'true'))
  #   inputs:
  #    To: 'kishore.ramachandraiah@aptean.com'
  #    From: '$(SMTP_MailID)'
  #    Subject: 'RS2 Automation reports'
  #    Body: |
  #          This is the body of the email. You can write your content here and use proper alignment.
                 
  #                         Thank you,
  #                         Your Name
  #    BodyAsHtml: false
  #    AddAttachment: true
  #    Attachment: '$(System.DefaultWorkingDirectory)\API_Automation_Cypress\Modulewise_TestCases\cypress\reports.zip'
  #    SmtpServer: 'smtp.office365.com'
  #    SmtpUsername: '$(SMTP_UserName)'
  #    SmtpPassword: '$(SMTP_UserPassword)'
- job: sendEmail
  condition: AND(succeededOrFailed(),ne(canceled(), 'true'))
  dependsOn: cypress
  pool: 
    vmImage: 'windows-latest'
  steps:
   - task: DownloadBuildArtifacts@1
     inputs:
       buildType: 'current'
       downloadType: 'single'
       artifactName: 'drop'
       downloadPath: '$(System.ArtifactsDirectory)'
   - task: SendEmail@1
     condition: AND(succeededOrFailed(),ne(canceled(), 'true'))
     inputs:
      To: 'ApteanOperations-DeepMatrix@aptean.com'
      From: 'RSautomation@aptean.com'
      Subject: 'RS2 Automation reports'
      Body: |
        This is the automation report.
                pipeline <a href="https://dev.azure.com/ApteanDACH/RS2/_build/results?buildId=$(Build.BuildId)&view=artifacts&pathAsName=false&type=publishedArtifacts"> link </a>
      BodyAsHtml: true
      SmtpServer: 'smtp.office365.com'
      AddAttachment: false
      Attachment: ''
      SmtpUsername: 'RSautomation@aptean.com'
      SmtpPassword: '$(SMTP_UserPassword)'
      UseSSL: true      